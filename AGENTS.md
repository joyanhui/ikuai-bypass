# AI rules

这是一个专门为 iKuai 路由器开发的自动化分流规则同步工具。它通过模拟 Web 管理界面的行为，将远程订阅的 IP/域名列表同步到路由器的分流设置中。并提供了一个webui来完成配置文件修改和启动参数的生成参考。

**永远用中文和我对话**

## 核心业务逻辑

### 1. 规则标识与命名约定 (关键)
项目使用特定的名字前缀和备注来识别和管理由本工具创建的规则：
- **名称前缀**: `IKB` (由 `ikuai_common.NAME_PREFIX_IKB` 定义)。所有创建的规则、分组名字必须以此开头。
- **统一备注**: `joyanhui/ikuai-bypass` (由 `ikuai_common.NEW_COMMENT` 定义)。所有规则的备注字段必须仅包含此常量。
- **命名规则**: 统一使用 `IKB + tag + 序号`。严禁随意更改此命名模版。
- **识别逻辑**: 程序通过“名字以 IKB 开头”或“备注包含 `joyanhui/ikuai-bypass`”来判断规则是否属于本工具管理。
- 旧版本兼容：为了兼容旧版,保留清理模式下对包含字符IKUAI_BYPASS的规则和分组的兼容支持

### 2. 执行与日志规范
- **顺序执行**: 所有更新任务（运营商、域名分流、IP分组等）必须**严格顺序执行**。严禁在核心逻辑中使用 goroutine 并发执行多个规则块，以确保日志输出顺序清晰、不交织，并防止爱快硬件因高并发 API 请求导致处理失败。
- **日志语言**: 所有面向用户的日志必须使用 **中文**。

### 3. 开发策略
- **配置一致性要求**: 
  - 新增或修改配置项时，必须确保 `config.yml`、`config_example.yml`、`pkg/config/config.go` 以及 `pkg/webui/webui.html` 四个位置同步更新。
  - 统一使用 `tag` 字段作为用户定义的标识符，不再使用 `name` 字段。
- **安全策略**: 
  - 任何模拟提交操作失败都不应导致现有数据丢失（Safe-Before 策略：先确认新数据下载成功，再执行删除旧规则）。
  - 配置文件的覆写必须经过后缀名和软链接校验，严禁写入非 YAML 格式内容。
  - **清理模式安全性**: 在运行 `-r clean` 时，必须强制用户显式指定 `-tag` 参数（特定标签或 `cleanAll`），严禁设置默认值，以防误删。
- **前端UI** ： `pkg/webui/webui.html` 使用 CDN 引入的 Tailwind CSS, Alpine.js, Bootstrap Icons。必须通过 `CDN_PREFIX` 占位符统一管理。

### 4. iKuai API 交互
- 逻辑位于 `pkg/ikuai_api4/` 目录。
- 工具通过模拟 Web 登录并发送 JSON POST 请求到 `/Action/call` 等内部接口实现。
- 核心 HTTP 通讯逻辑封装在 `postJson` 及相关工具函数中。

## 调试与运行 (CLI Flags)
本工具高度依赖命令行参数进行调试和功能切换，具体参数的意义参考 @README.md 或 @pkg/config/config.go中flag的定义。

## 开发与贡献规范

### 1. 语言与注释规范 (重要)
- **代码注释**: 必须使用 **双语文本 (中文 & 英文)**。注释应重点说明“为什么”（Why）存在这段逻辑，其次是“做了什么”（What）。
- **日志标签 (Log Tags)**: 必须使用 **中文**。这些标签作为日志的前缀，方便用户直观了解当前进度。例如：`[LOGIN:登录失败]`、`[UPDATE:开始更新]`。
- **日志详情 (Log Details)**: 建议使用 **英文**。这有助于确保在不同系统字符集下的兼容性，并方便在遇到底层错误时进行精确比对和调试。
- **界面返回与错误信息**: 必须使用 **英文**。确保核心 API 和内部逻辑报错的专业性和一致性。

### 2. 配置扩展
若增加新功能，需同步修改 `config.yml` 示例、`pkg/config/config.go` 中的结构体定义以及 `readConf` 函数中的默认值处理逻辑。并且需要修改 pkg/webui/webui.html 的自动创建yaml文件的功能。

### 3. 依赖项
项目保持轻量化，主要依赖 `cron` 进行任务调度和 `yaml.v3` 处理配置，尽量避免引入大型第三方框架。
