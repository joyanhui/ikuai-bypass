# 更新日志 (2026-03-01)

## 核心改进：平滑更新策略 (Edit Over Add)

为了解决 iKuai 路由器分流规则更新时 ID 频繁变动导致的问题，本项目对所有核心模块的更新逻辑进行了重构。

### 1. 全模块原地更新保障
- **影响模块**：IPv4 分组、IPv6 分组、自定义运营商 (Custom ISP)、域名分流 (Domain Streaming)、端口分流 (Port Streaming)。
- **新策略**：由原先的“先删后加”或“先加后删”改为“**先查询、匹配则修改 (Edit)、不匹配则新建 (Add)**”。
- **ID 稳定性**：通过建立 `序号/名称 -> ID` 的映射映射表，优先调用 `edit` 接口。这确保了在更新过程中，绝大部分规则的爱快内部 ID 保持不变，避免了依赖 ID 的其他功能（如ACL等策略引用）失效。

### 2. 严格的数据安全保护 (Safe-Before 原则)
- **下载失败保护**：推广至所有涉及远程下载的模块。如果订阅源下载失败（网络超时、DNS 错误）或 HTTP 状态码非 200，程序将立即终止当前项的更新。
- **零风险回退**：在下载失败时，**绝对不会执行任何删除操作**。这保证了路由器中现有的分流规则依然有效，避免了因订阅源暂时失效导致的大规模配置丢失或断网。
- **故障隔离**：失败仅影响当前的特定规则项。如果用户配置了多个规则，其中一个地址错误不会影响其他正常规则的更新。

### 3. 增强的冗余清理与详细日志
- **智能清理**：当新配置的分片数量减少时，程序会自动识别并清理不再需要的旧规则分片。
- **日志审计**：在删除这些冗余规则时，日志会清晰地打印出被删除规则的**完整名字、分片序号以及爱快内部 ID**，极大地方便了管理员进行审计和回溯。
- **示例日志**：`[CLEAN:冗余删除] IKB国内: chunk 6 (ID: 105) is no longer needed, deleting...`

## 网络与代理优化

### 1. 统一 HTTP 封装
- 新增 `pkg/utils/http.go` 工具模块，将全项目分散的 `http.Get` 逻辑统一封装为 `HttpGet` 函数。
- 实现了统一的响应体读取与资源关闭逻辑，增强了网络请求的健壮性。

### 2. 智能 GitHub 代理 (github-proxy)
- **精准匹配触发**：优化了代理拼接逻辑，仅针对 `raw.githubusercontent.com` 和 `github.com` 的请求自动应用代理，避免非 GitHub 资源误用代理。
- **增强日志透明度**：在资源下载日志中显式打印代理地址。
- **示例格式**：`http.get 'https://raw.githubusercontent.com/xxx' proxy 'https://gh-proxy.com/'`
## 功能清理与优化

### 1. 移除域名分组功能
- 经确认，**域名分组 (Domain Group)** 功能不属于本项目核心业务范围，已将其从代码库中完整移除。
- 删除了相关的底层 API (`pkg/ikuai_api4/domain_group.go`)、业务逻辑 (`pkg/utils/update_domain_group.go`) 以及接口定义。

### 2. 架构深度重构与清理
- **移除过时逻辑**：彻底剔除了所有旧有的“先删后加”逻辑代码，统一了底层编辑动作实现。
- **接口精简**：从 `IKuaiClient` 接口及其实现中删除了 `GetCustomIspAll`, `DelCustomIspFromPreIds`, `GetStreamDomainAll`, `GetStreamIpPortIdsByTag` 等 10 余个不再需要的辅助函数。
- **策略固化**：同步更新了 `AGENTS.md` 指南，将最新的“原地更新”、“故障单点隔离”和“Safe-Before”原则正式固定下来。
- **匹配健壮性**：针对爱快 4.0 TagName 15 字符长度限制，优化了通过后缀数字找回 ID 的智能匹配逻辑。

---
*本日志记录了 2026 年 3 月 1 日的所有核心改动。*
