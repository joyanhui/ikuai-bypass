# 更新日志 (2026-03-02)

## 核心修复：自定义运营商 ISP 分片兼容性回归

为修复 v4.4.11 在自定义运营商（Custom ISP）模块中出现的分片匹配回归问题，本次更新对 ISP 分片命名与匹配策略进行了专项修正。

### 1. 分片命名策略回归到同名模式
- **修复目标**：避免 ISP 分片使用名字后缀序号导致的匹配偏差。
- **新策略**：分片规则名称统一为同名 `IKB+tag`，不再在名字中拼接分片序号。
- **备注策略**：分片序号仅写入备注字段（如 `joyanhui/ikuai-bypass`、`joyanhui/ikuai-bypass-2`、`joyanhui/ikuai-bypass-3`）。

### 2. 分片匹配策略调整为“备注序号优先”
- **匹配规则**：查询与更新时优先从备注解析分片序号，按“序号 -> ID”建立映射。
- **兼容回退**：若备注序号不可解析，回退到旧数据的名字后缀序号解析，兼容 v4.4.11 已落地存量规则。
- **更新行为**：命中分片序号执行 Edit；未命中执行 Add；更新后删除冗余分片。

### 3. 冗余清理与稳定性保障
- **冗余清理**：当新分片数量减少时，删除未命中的历史分片，避免规则残留。
- **冲突处理**：若同一分片序号出现重复映射，保留首个并输出警告日志，避免误覆盖。

### 4. 代码与验证
- **影响文件**：
  - `pkg/ikuai_api4/custom_isp.go`
  - `pkg/ikuai_api4/custom_isp_test.go`（新增）
- **验证结果**：
  - `go test ./...` 通过
  - `go build ./...` 通过
  - `go test ./pkg/ikuai_api4` 通过

---
*本日志记录了 2026 年 3 月 2 日针对自定义运营商 ISP 分片兼容性回归的完整修复内容。*
