<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>iKuai Bypass 配置助手</title>
        <script src="{{CDN_PREFIX}}/@tailwindcss/browser@4"></script>
        <!-- Alpine.js -->
        <script
            defer
            src="{{CDN_PREFIX}}/alpinejs@3.13.3/dist/cdn.min.js"
        ></script>
        <link
            rel="stylesheet"
            href="{{CDN_PREFIX}}/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />
        <script src="{{CDN_PREFIX}}/js-yaml@4.1.1/dist/js-yaml.min.js"></script>
        <style>
            [x-cloak] {
                display: none !important;
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen font-sans" x-data="appData()">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div
                    class="flex flex-col md:flex-row justify-between items-center"
                >
                    <div>
                        <h1 class="text-3xl font-bold flex items-center gap-2">
                            <i class="bi bi-router"></i> iKuai Bypass 助手
                        </h1>
                        <p class="mt-2 text-blue-100 text-sm">
                            爱快路由器自动化分流规则同步工具配置生成器（这是一个测试功能，需谨慎使用）
                        </p>
                    </div>
                    <div class="mt-4 md:mt-0 flex gap-3">
                        <a
                            href="https://github.com/joyanhui/ikuai-bypass"
                            target="_blank"
                            class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition text-sm flex items-center gap-2"
                        >
                            <i class="bi bi-github"></i> GitHub
                        </a>
                        <a
                            href="https://github.com/joyanhui/ikuai-bypass/releases"
                            target="_blank"
                            class="bg-white text-blue-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition text-sm font-semibold flex items-center gap-2"
                        >
                            <i class="bi bi-download"></i> 下载 Release
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Tabs -->
            <div class="bg-white rounded-t-xl shadow-sm border-b">
                <nav class="flex">
                    <button
                        @click="currentTab = 'tool'"
                        :class="{'border-blue-500 text-blue-600': currentTab === 'tool', 'border-transparent text-gray-500 hover:text-gray-700': currentTab !== 'tool'}"
                        class="px-6 py-4 text-sm font-medium border-b-2 transition flex items-center gap-2"
                    >
                        <i class="bi bi-gear-fill"></i> 配置助手
                    </button>
                    <button
                        @click="currentTab = 'help'"
                        :class="{'border-blue-500 text-blue-600': currentTab === 'help', 'border-transparent text-gray-500 hover:text-gray-700': currentTab !== 'help'}"
                        class="px-6 py-4 text-sm font-medium border-b-2 transition flex items-center gap-2"
                    >
                        <i class="bi bi-question-circle"></i> 使用说明
                    </button>
                </nav>
            </div>

            <div class="bg-white rounded-b-xl shadow-md p-6 min-h-[500px]">
                <!-- Tab: Tool (Combined Command + Config) -->
                <div x-show="currentTab === 'tool'" x-cloak class="space-y-12">
                    <!-- Section 1: Command Builder -->
                    <section class="space-y-6">
                        <div class="flex items-center justify-between border-b pb-2">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="bi bi-terminal"></i> 1. 运行命令生成
                            </h2>
                            <div class="flex gap-2">
                                <button
                                    @click="restoreDefaultCmd()"
                                    class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition flex items-center gap-1"
                                >
                                    <i class="bi bi-arrow-counterclockwise"></i> 恢复默认
                                </button>
                                <div class="relative" x-data="{ open: false }">
                                    <button
                                        @click="open = !open"
                                        class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition flex items-center gap-1"
                                    >
                                        <i class="bi bi-bookmark-plus"></i> 命令预设 <span x-text="`(${presets.length}/5)`"></span>
                                    </button>
                                    <div
                                        x-show="open"
                                        @click.away="open = false"
                                        class="absolute right-0 mt-2 w-72 bg-white border rounded-lg shadow-xl z-50 p-4 space-y-3"
                                        x-cloak
                                    >
                                        <div class="flex justify-between items-center border-b pb-2">
                                            <span class="font-bold text-sm">已存预设</span>
                                            <button @click="savePreset()" :disabled="presets.length >= 5" class="text-blue-600 text-xs font-bold disabled:text-gray-400">
                                                + 保存当前
                                            </button>
                                        </div>
                                        <div class="max-h-60 overflow-y-auto space-y-2">
                                            <template x-for="(p, index) in presets" :key="index">
                                                <div class="group flex items-center justify-between p-2 hover:bg-gray-50 rounded border">
                                                    <div class="flex-1 cursor-pointer" @click="loadPreset(index); open = false">
                                                        <div class="text-xs font-bold text-gray-800" x-text="p.name"></div>
                                                        <div class="text-[10px] text-gray-500 truncate w-40" x-text="p.runMode"></div>
                                                    </div>
                                                    <div class="flex gap-1">
                                                        <button @click.stop="renamePreset(index)" class="text-gray-400 hover:text-blue-600 p-1">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                        <button @click.stop="deletePreset(index)" class="text-gray-400 hover:text-red-600 p-1">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                            <div x-show="presets.length === 0" class="text-center py-4 text-gray-400 text-xs">
                                                暂无预设
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Left: Form -->
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-1"
                                            >配置文件路径 (-c)</label
                                        >
                                        <input
                                            type="text"
                                            x-model="cmd.configPath"
                                            class="w-full border p-2 rounded focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="./config.yml"
                                        />
                                    </div>
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-1"
                                            >运行模式 (-r)</label
                                        >
                                        <select
                                            x-model="cmd.runMode"
                                            class="w-full border p-2 rounded"
                                        >
                                            <option value="cron">
                                                cron (计划任务模式:
                                                立即执行一次，随后定时)
                                            </option>
                                            <option value="cronAft">
                                                cronAft (延迟计划任务:
                                                不立即执行，直接进入定时)
                                            </option>
                                            <option value="once">
                                                once (单次模式:
                                                立即执行一次并退出)
                                            </option>
                                            <option value="web">
                                                web (WebUI 模式: 仅启动 Web
                                                界面)
                                            </option>
                                            <option value="clean">
                                                clean (清理模式:
                                                删除指定备注的规则)
                                            </option>
                                            <option
                                                value="exportDomainSteamToTxt"
                                            >
                                                exportDomainSteamToTxt
                                                (导出模式: 导出为爱快 TXT)
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-1"
                                        >功能模块 (-m)</label
                                    >
                                    <select
                                        x-model="cmd.module"
                                        class="w-full border p-2 rounded"
                                    >
                                        <option value="ispdomain">
                                            ispdomain (默认: 运营商+域名分流)
                                        </option>
                                        <option value="ipgroup">
                                            ipgroup (IP分组+端口分流)
                                        </option>
                                        <option value="ipv6group">
                                            ipv6group (IPv6分组)
                                        </option>
                                        <option value="ii">
                                            ii (混合: ispdomain + ipgroup)
                                        </option>
                                        <option value="ip">
                                            ip (混合: ipgroup + ipv6group)
                                        </option>
                                    </select>
                                </div>

                                <div
                                    class="p-4 bg-gray-50 rounded border border-gray-200"
                                >
                                    <label
                                        class="flex items-center gap-2 mb-2 cursor-pointer"
                                    >
                                        <input
                                            type="checkbox"
                                            x-model="cmd.useCustomLogin"
                                            class="rounded text-blue-600"
                                        />
                                        <span
                                            class="text-sm font-medium text-gray-700"
                                            >覆盖配置文件的登录信息
                                            (-login)</span
                                        >
                                    </label>
                                    <div
                                        x-show="cmd.useCustomLogin"
                                        class="space-y-2 mt-2"
                                    >
                                        <input
                                            type="text"
                                            x-model="cmd.loginUrl"
                                            placeholder="http://192.168.1.1"
                                            class="w-full text-sm border p-2 rounded"
                                        />
                                        <div class="grid grid-cols-2 gap-2">
                                            <input
                                                type="text"
                                                x-model="cmd.loginUser"
                                                placeholder="admin"
                                                class="w-full text-sm border p-2 rounded"
                                            />
                                            <input
                                                type="text"
                                                x-model="cmd.loginPass"
                                                placeholder="password"
                                                class="w-full text-sm border p-2 rounded"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div
                                    x-show="cmd.runMode === 'clean'"
                                    class="p-4 bg-red-50 rounded border border-red-200"
                                >
                                    <div
                                        class="flex justify-between items-center mb-1"
                                    >
                                        <label
                                            class="block text-sm font-medium text-red-700"
                                            >清理标签 (-tag)</label
                                        >
                                        <button
                                            @click="cmd.cleanTag = 'cleanAll'"
                                            class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded hover:bg-red-200 transition"
                                        >
                                            使用 cleanAll
                                        </button>
                                    </div>
                                    <input
                                        type="text"
                                        x-model="cmd.cleanTag"
                                        class="w-full text-sm border p-2 rounded border-red-300"
                                        placeholder="默认为 cleanAll"
                                    />
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-1"
                                            >旧规则删除时机 (-delOldRule)</label
                                        >
                                        <select
                                            x-model="cmd.delOldRule"
                                            class="w-full border p-2 rounded"
                                        >
                                            <option value="after">
                                                after (更新成功后删)
                                            </option>
                                            <option value="before">
                                                before (更新前先删)
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-1"
                                            >IP分组名随机后缀
                                            (-isIpGroupNameAddRandomSuff)</label
                                        >
                                        <select
                                            x-model="cmd.randomSuff"
                                            class="w-full border p-2 rounded"
                                        >
                                            <option value="1">1 (开启)</option>
                                            <option value="0">0 (关闭)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Output -->
                            <div class="space-y-4">
                                <div
                                    class="bg-gray-900 rounded-lg p-6 text-gray-100 font-mono relative group"
                                >
                                    <div
                                        class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition"
                                    >
                                        <button
                                            @click="copyToClipboard(generatedCommand)"
                                            class="bg-white/20 hover:bg-white/30 text-white text-xs px-2 py-1 rounded"
                                        >
                                            <i class="bi bi-clipboard"></i> 复制
                                        </button>
                                    </div>
                                    <h3
                                        class="text-gray-400 text-xs uppercase font-bold mb-2"
                                    >
                                        Generated Command
                                    </h3>
                                    <div
                                        class="break-all whitespace-pre-wrap text-sm"
                                        x-text="generatedCommand"
                                    ></div>
                                </div>

                                <!-- Tips Area -->
                                <div
                                    class="bg-blue-50 border border-blue-200 rounded-lg p-4"
                                >
                                    <h4
                                        class="text-sm font-bold text-blue-800 flex items-center gap-1 mb-1"
                                    >
                                        <i class="bi bi-info-circle"></i>
                                        运行模式说明:
                                    </h4>
                                    <p
                                        class="text-xs text-blue-700 leading-relaxed"
                                        x-text="runModeDescription"
                                    ></p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Section 2: Config Editor -->
                    <section class="space-y-6 pt-6">
                        <div
                            class="flex items-center justify-between border-b pb-2"
                        >
                            <h2
                                class="text-xl font-bold text-gray-800 flex items-center gap-2"
                            >
                                <i class="bi bi-file-earmark-code"></i> 2.
                                配置文件生成 (Config.yml)
                            </h2>
                            <p class="text-xs text-gray-500">
                                <span class="text-red-500 font-bold">*</span>
                                表示该项修改后需重启程序才可生效
                            </p>
                        </div>

                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="space-y-4 col-span-1">
                                <h3
                                    class="font-bold text-gray-800 border-b pb-2"
                                >
                                    基础配置
                                </h3>
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase"
                                        >iKuai URL</label
                                    >
                                    <input
                                        type="text"
                                        x-model="config.ikuaiUrl"
                                        class="w-full border p-2 rounded text-sm"
                                        placeholder="http://192.168.1.1"
                                    />
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label
                                            class="text-xs font-bold text-gray-500 uppercase"
                                            >Username</label
                                        >
                                        <input
                                            type="text"
                                            x-model="config.username"
                                            class="w-full border p-2 rounded text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label
                                            class="text-xs font-bold text-gray-500 uppercase"
                                            >Password</label
                                        >
                                        <input
                                            type="text"
                                            x-model="config.password"
                                            class="w-full border p-2 rounded text-sm"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase"
                                        >计划任务表达式 <span
                                            class="text-red-500 text-xs font-normal ml-1"
                                            >(修改需重启)</span
                                        <span class="text-red-500"
                                            >*</span
                                        ></label>

                                        <a
                                            href="https://tooltool.net/zh/crontab" target="_blank"
                                            class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded hover:bg-green-200 transition"
                                        >
                                             在线解析
                                        </a>
                                    <input
                                        type="text"
                                        x-model="config.cron"
                                        class="w-full border p-2 rounded text-sm"
                                        placeholder="0 7 * * *"
                                    />
                                </div>
                            </div>

                            <div class="space-y-4 col-span-1">
                                <h3
                                    class="font-bold text-gray-800 border-b pb-2"
                                >
                                    高级选项
                                </h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label
                                            class="text-xs font-bold text-gray-500 uppercase"
                                            >Retry Wait</label
                                        >
                                        <input
                                            type="text"
                                            x-model="config.addErrRetryWait"
                                            class="w-full border p-2 rounded text-sm"
                                            placeholder="10s"
                                        />
                                    </div>
                                    <div>
                                        <label
                                            class="text-xs font-bold text-gray-500 uppercase"
                                            >Add Wait</label
                                        >
                                        <input
                                            type="text"
                                            x-model="config.addWait"
                                            class="w-full border p-2 rounded text-sm"
                                            placeholder="1s"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- WebUI Settings -->
                            <div class="space-y-4 col-span-1">
                                <h3
                                    class="font-bold text-gray-800 border-b pb-2"
                                >
                                    WebUI 设置
                                    <span
                                        class="text-red-500 text-xs font-normal ml-1"
                                        >(修改需重启)</span
                                    >
                                </h3>
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase"
                                        >启用 WebUI
                                        <span class="text-red-500"
                                            >*</span
                                        ></label
                                    >
                                    <select
                                        x-model="config.webui.enable"
                                        class="w-full border p-2 rounded text-sm"
                                    >
                                        <option :value="false">
                                            false (不启用)
                                        </option>
                                        <option :value="true">
                                            true (启用)
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase"
                                        >Port
                                        <span class="text-red-500"
                                            >*</span
                                        ></label
                                    >
                                    <input
                                        type="text"
                                        x-model="config.webui.port"
                                        class="w-full border p-2 rounded text-sm"
                                        placeholder="8080"
                                    />
                                </div>
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase"
                                        >Username
                                        <span class="text-red-500"
                                            >*</span
                                        ></label
                                    >
                                    <input
                                        type="text"
                                        x-model="config.webui.user"
                                        class="w-full border p-2 rounded text-sm"
                                        placeholder="admin"
                                    />
                                </div>
                                                                <div>
                                                                    <label
                                                                        class="text-xs font-bold text-gray-500 uppercase"
                                                                        >Password <span class="text-red-500">*</span></label
                                                                    >
                                                                    <input
                                                                        type="text"
                                                                        x-model="config.webui.pass"
                                                                        class="w-full border p-2 rounded text-sm"
                                                                        placeholder="leave empty to disable auth"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label
                                                                        class="text-xs font-bold text-gray-500 uppercase"
                                                                        >CDN Prefix <span class="text-red-500">*</span></label
                                                                    >
                                                                    <input
                                                                        type="text"
                                                                        x-model="config.webui.cdnPrefix"
                                                                        class="w-full border p-2 rounded text-sm"
                                                                        placeholder="https://cdn.jsdelivr.net/npm"
                                                                    />
                                                                </div>
                                                            </div>
                                                        </div>

                        <!-- Custom ISP -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between items-center border-b pb-2"
                            >
                                <h3 class="font-bold text-gray-800">
                                    自定义运营商 (Custom ISP)
                                </h3>
                                <button
                                    @click="addItem('customIsp')"
                                    class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded transition"
                                >
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                            <template
                                x-for="(item, index) in config.customIsp"
                                :key="index"
                            >
                                <div
                                    class="grid md:grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border border-gray-100"
                                >
                                    <div class="md:col-span-3">
                                        <input
                                            type="text"
                                            x-model="item.name"
                                            placeholder="Name (e.g., 国内IP)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-6">
                                        <input
                                            type="text"
                                            x-model="item.url"
                                            placeholder="URL (txt/cidr)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-2">
                                        <input
                                            type="text"
                                            x-model="item.tag"
                                            placeholder="Tag (optional)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-1 text-right">
                                        <button
                                            @click="removeItem('customIsp', index)"
                                            class="text-red-500 hover:text-red-700"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Stream Domain -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between items-center border-b pb-2"
                            >
                                <h3 class="font-bold text-gray-800">
                                    域名分流 (Stream Domain)
                                </h3>
                                <button
                                    @click="addItem('streamDomain')"
                                    class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded transition"
                                >
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                            <template
                                x-for="(item, index) in config.streamDomain"
                                :key="index"
                            >
                                <div
                                    class="grid md:grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border border-gray-100"
                                >
                                    <div class="md:col-span-2">
                                        <input
                                            type="text"
                                            x-model="item.interface"
                                            placeholder="Interface (wan1)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-3">
                                        <input
                                            type="text"
                                            x-model="item.srcAddr"
                                            placeholder="Src Addr (192.168.1.1-10)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-5">
                                        <input
                                            type="text"
                                            x-model="item.url"
                                            placeholder="Domain List URL"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-1">
                                        <input
                                            type="text"
                                            x-model="item.tag"
                                            placeholder="Tag"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-1 text-right">
                                        <button
                                            @click="removeItem('streamDomain', index)"
                                            class="text-red-500 hover:text-red-700"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- IP Group -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between items-center border-b pb-2"
                            >
                                <h3 class="font-bold text-gray-800">
                                    IP 分组 (IP Group)
                                </h3>
                                <button
                                    @click="addItem('ipGroup')"
                                    class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded transition"
                                >
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                            <template
                                x-for="(item, index) in config.ipGroup"
                                :key="index"
                            >
                                <div
                                    class="grid md:grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border border-gray-100"
                                >
                                    <div class="md:col-span-4">
                                        <input
                                            type="text"
                                            x-model="item.name"
                                            placeholder="Group Name (e.g., Telegram)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-7">
                                        <input
                                            type="text"
                                            x-model="item.url"
                                            placeholder="URL"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-1 text-right">
                                        <button
                                            @click="removeItem('ipGroup', index)"
                                            class="text-red-500 hover:text-red-700"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- IPv6 Group -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between items-center border-b pb-2"
                            >
                                <h3 class="font-bold text-gray-800">
                                    IPv6 分组 (IPv6 Group)
                                </h3>
                                <button
                                    @click="addItem('ipv6Group')"
                                    class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded transition"
                                >
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                            <template
                                x-for="(item, index) in config.ipv6Group"
                                :key="index"
                            >
                                <div
                                    class="grid md:grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border border-gray-100"
                                >
                                    <div class="md:col-span-4">
                                        <input
                                            type="text"
                                            x-model="item.name"
                                            placeholder="Group Name (e.g., 国内v6)"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-7">
                                        <input
                                            type="text"
                                            x-model="item.url"
                                            placeholder="URL"
                                            class="w-full text-xs border p-1 rounded"
                                        />
                                    </div>
                                    <div class="md:col-span-1 text-right">
                                        <button
                                            @click="removeItem('ipv6Group', index)"
                                            class="text-red-500 hover:text-red-700"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Stream IP Port -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between items-center border-b pb-2"
                            >
                                <h3 class="font-bold text-gray-800">
                                    端口分流 (Stream IP/Port)
                                </h3>
                                <button
                                    @click="addItem('streamIpPort')"
                                    class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded transition"
                                >
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                            <template
                                x-for="(item, index) in config.streamIpPort"
                                :key="index"
                            >
                                <div
                                    class="bg-gray-50 p-3 rounded border border-gray-100 space-y-2"
                                >
                                    <div class="grid grid-cols-12 gap-2">
                                        <div class="col-span-2">
                                            <select
                                                x-model="item.type"
                                                class="w-full text-xs border p-1 rounded"
                                                title="Type"
                                            >
                                                <option value="0">
                                                    外网线路 (0)
                                                </option>
                                                <option value="1">
                                                    下一跳网关 (1)
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-span-3">
                                            <input
                                                x-show="item.type == '0'"
                                                type="text"
                                                x-model="item.interface"
                                                placeholder="Interface (wan1)"
                                                class="w-full text-xs border p-1 rounded"
                                            />
                                            <input
                                                x-show="item.type == '1'"
                                                type="text"
                                                x-model="item.nexthop"
                                                placeholder="Next Hop IP"
                                                class="w-full text-xs border p-1 rounded"
                                            />
                                        </div>
                                        <div class="col-span-3">
                                            <input
                                                type="text"
                                                x-model="item.srcAddr"
                                                placeholder="Src Addr"
                                                class="w-full text-xs border p-1 rounded"
                                            />
                                        </div>
                                        <div class="col-span-3">
                                            <input
                                                type="text"
                                                x-model="item.ipGroup"
                                                placeholder="IP Group Name"
                                                class="w-full text-xs border p-1 rounded"
                                            />
                                        </div>
                                        <div class="col-span-1 text-right">
                                            <button
                                                @click="removeItem('streamIpPort', index)"
                                                class="text-red-500 hover:text-red-700"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-12 gap-2">
                                        <div
                                            class="col-span-6 flex items-center gap-2"
                                        >
                                            <label class="text-xs text-gray-500"
                                                >Mode:</label
                                            >
                                            <select
                                                x-model="item.mode"
                                                class="w-full text-xs border p-1 rounded"
                                            >
                                                <option value="0">
                                                    0-新建连接数
                                                </option>
                                                <option value="1">
                                                    1-源IP
                                                </option>
                                                <option value="2">
                                                    2-源IP+源端口
                                                </option>
                                                <option value="3">
                                                    3-源IP+目的IP
                                                </option>
                                            </select>
                                        </div>
                                        <div
                                            class="col-span-6 flex items-center gap-2"
                                        >
                                            <label class="text-xs text-gray-500"
                                                >IfaceBand:</label
                                            >
                                            <select
                                                x-model="item.ifaceband"
                                                class="w-full text-xs border p-1 rounded"
                                            >
                                                <option value="0">
                                                    0-不勾选
                                                </option>
                                                <option value="1">
                                                    1-勾选
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Result -->
                        <div class="mt-8">
                            <h3 class="font-bold text-gray-800 mb-2">
                                YAML 预览
                            </h3>
                            <textarea
                                class="w-full h-96 bg-gray-900 text-gray-100 font-mono text-sm p-4 rounded-lg"
                                readonly
                                x-text="generatedYaml"
                            ></textarea>
                            <div class="flex gap-4 mt-2">
                                <button
                                    @click="copyToClipboard(generatedYaml)"
                                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition flex-1"
                                >
                                    <i class="bi bi-clipboard"></i> 复制完整配置
                                </button>
                                <button
                                    @click="saveConfig()"
                                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition flex-1"
                                >
                                    <i class="bi bi-hdd"></i> 保存到服务器
                                    (config.yml)
                                </button>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Help (Simple Text) -->
                <div
                    x-show="currentTab === 'help'"
                    x-cloak
                    class="prose max-w-none text-gray-700 space-y-4"
                >
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800 m-0">
                            快速使用说明
                        </h2>
                        <div class="flex gap-4">
                            <a href="https://github.com/joyanhui/ikuai-bypass" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium">
                                <i class="bi bi-github"></i> 项目主页
                            </a>
                            <a href="https://github.com/joyanhui/ikuai-bypass/blob/main/README.md" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium">
                                <i class="bi bi-file-text"></i> 详细文档 (README)
                            </a>
                        </div>
                    </div>

                    <div
                        class="bg-blue-50 p-4 rounded-lg border border-blue-100"
                    >
                        <p class="font-bold text-blue-800">第一步：配置准备</p>
                        <p>
                            在“配置助手”页面的下方，填写您的爱快路由器登录信息。根据需求在 <b>自定义运营商</b>、<b>域名分流</b> 或 <b>IP分组</b> 中添加订阅地址。
                        </p>
                    </div>
                    <div
                        class="bg-green-50 p-4 rounded-lg border border-green-100"
                    >
                        <p class="font-bold text-green-800">第二步：保存配置</p>
                        <p>
                            您可以直接点击页面底部的 <b>“保存到服务器”</b> 按钮，程序会自动将配置安全地写入当前的 <code>config.yml</code> 文件。
                            或者点击“复制完整配置”，手动保存到程序同目录下的配置文件中。
                        </p>
                    </div>
                    <div
                        class="bg-purple-50 p-4 rounded-lg border border-purple-100"
                    >
                        <p class="font-bold text-purple-800">
                            第三步：执行程序
                        </p>
                        <p>
                            在“运行命令生成”处选择运行模式：
                            <ul class="list-disc pl-5 mt-2 text-sm">
                                <li><b>cron</b>: 立即同步一次，随后根据 Cron 表达式定时运行。</li>
                                <li><b>once</b>: 仅执行一次同步并立即退出（适合系统任务计划）。</li>
                                <li><b>web</b>: 仅启动此管理后台，不执行同步。</li>
                                <li><b>clean</b>: 清理所有由本工具创建的分流规则。</li>
                            </ul>
                            复制生成的命令并在终端/脚本中执行。
                        </p>
                    </div>
                    <hr />
                    <h3 class="font-bold text-lg">注意事项：</h3>
                    <ul class="list-disc pl-5 space-y-2 text-sm">
                        <li>
                            <b>重启生效</b>：带有 <span class="text-red-500">*</span> 标注的配置项（如 Cron 表达式、WebUI 端口）在保存后，需要手动重启程序才能生效。
                        </li>
                        <li>
                            <b>配置文件</b>：保存操作会保留关键注释说明，方便您日后手动编辑。
                        </li>
                        <li>
                            <b>安全性</b>：建议在 WebUI 设置中配置用户名和密码，以保护您的配置信息。
                        </li>
                    </ul>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-gray-400 py-8 text-center mt-12">
            <p class="mb-2">iKuai Bypass Helper Tool</p>
        </footer>

        <script>
            function appData() {
                return {
                    currentTab: "tool",

                    // Command Logic
                    cmd: {
                        exePath: "./ikuai-bypass",
                        configPath: "./config.yml",
                        runMode: "cron",
                        module: "ispdomain",
                        useCustomLogin: false,
                        loginUrl: "",
                        loginUser: "",
                        loginPass: "",
                        cleanTag: "",
                        delOldRule: "after",
                        randomSuff: "1",
                    },

                    presets: [],

                    // Config Logic
                    config: {
                        ikuaiUrl: "http://192.168.1.1",
                        username: "admin",
                        password: "password",
                        cron: "0 7 * * *",
                        addErrRetryWait: "10s",
                        addWait: "1s",
                        webui: {
                            enable: false,
                            port: "8080",
                            user: "",
                            pass: "",
                            cdnPrefix: "https://cdn.jsdelivr.net/npm",
                        },
                        customIsp: [
                            {
                                name: "国内IP列表",
                                url: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/text/cn.txt",
                                tag: "ipcn",
                            },
                        ],
                        streamDomain: [],
                        ipGroup: [],
                        ipv6Group: [],
                        streamIpPort: [],
                    },

                    init() {
                        this.loadConfig();
                        this.loadPresets();
                    },

                    loadPresets() {
                        const saved = localStorage.getItem("cmd_presets");
                        if (saved) {
                            try {
                                this.presets = JSON.parse(saved);
                            } catch (e) {
                                this.presets = [];
                            }
                        }
                    },

                    savePresetsToStorage() {
                        localStorage.setItem("cmd_presets", JSON.stringify(this.presets));
                    },

                    savePreset() {
                        if (this.presets.length >= 5) {
                            alert("最多只能保存 5 个预设");
                            return;
                        }
                        const name = prompt("请输入预设名称:", `预设 ${this.presets.length + 1}`);
                        if (!name) return;

                        this.presets.push({
                            name: name,
                            data: JSON.parse(JSON.stringify(this.cmd))
                        });
                        this.savePresetsToStorage();
                    },

                    loadPreset(index) {
                        this.cmd = JSON.parse(JSON.stringify(this.presets[index].data));
                    },

                    deletePreset(index) {
                        if (confirm(`确定要删除预设 "${this.presets[index].name}" 吗？`)) {
                            this.presets.splice(index, 1);
                            this.savePresetsToStorage();
                        }
                    },

                    renamePreset(index) {
                        const newName = prompt("请输入新的预设名称:", this.presets[index].name);
                        if (newName) {
                            this.presets[index].name = newName;
                            this.savePresetsToStorage();
                        }
                    },

                    restoreDefaultCmd() {
                        if (confirm("确定要恢复命令生成的默认设置吗？")) {
                            this.cmd = {
                                exePath: this.cmd.exePath, // 保留从服务器获取的路径
                                configPath: "./config.yml",
                                runMode: "cron",
                                module: "ispdomain",
                                useCustomLogin: false,
                                loginUrl: "",
                                loginUser: "",
                                loginPass: "",
                                cleanTag: "",
                                delOldRule: "after",
                                randomSuff: "1",
                            };
                        }
                    },

                    async loadConfig() {
                        try {
                            const response = await fetch("/api/config");
                            if (!response.ok) return; // Might be running in standalone/file mode
                            const data = await response.json();

                            if (data.exe_path) {
                                this.cmd.exePath = data.exe_path;
                            }

                            // Map Go struct to JS object
                            this.config.ikuaiUrl = data["ikuai-url"] || "";
                            this.config.username = data.username || "";
                            this.config.password = data.password || "";
                            this.config.cron = data.cron || "";
                            this.config.addErrRetryWait =
                                (data.AddErrRetryWait || 0) / 1000000000 + "s"; // ns to s approximation for display
                            this.config.addWait =
                                (data.AddWait || 0) / 1000000000 + "s";

                            if (data.webui) {
                                this.config.webui.enable =
                                    data.webui.enable || false;
                                this.config.webui.port =
                                    data.webui.port || "8080";
                                this.config.webui.user = data.webui.user || "";
                                this.config.webui.pass = data.webui.pass || "";
                                this.config.webui.cdnPrefix = data.webui["cdn-prefix"] || "https://cdn.jsdelivr.net/npm";
                            }

                            // Arrays
                            this.config.customIsp = (
                                data["custom-isp"] || []
                            ).map((i) => ({
                                name: i.name,
                                url: i.url,
                                tag: i.tag,
                            }));
                            this.config.streamDomain = (
                                data["stream-domain"] || []
                            ).map((i) => ({
                                interface: i.interface,
                                srcAddr: i["src-addr"],
                                url: i.url,
                                tag: i.tag,
                            }));
                            this.config.ipGroup = (data["ip-group"] || []).map(
                                (i) => ({ name: i.name, url: i.url }),
                            );
                            this.config.ipv6Group = (data["ipv6-group"] || []).map(
                                (i) => ({ name: i.name, url: i.url }),
                            );
                            this.config.streamIpPort = (
                                data["stream-ipport"] || []
                            ).map((i) => ({
                                type: i.type,
                                interface: i.interface,
                                nexthop: i.nexthop,
                                srcAddr: i["src-addr"],
                                ipGroup: i["ip-group"],
                                mode: i.mode,
                                ifaceband: i.ifaceband,
                            }));

                            // Fix time duration string format if it came back as number from JSON unmarshal
                            if (typeof data.AddErrRetryWait === "string")
                                this.config.addErrRetryWait =
                                    data.AddErrRetryWait;
                            if (typeof data.AddWait === "string")
                                this.config.addWait = data.AddWait;

                            // Update Command Generator defaults if custom login is not checked yet
                            // Optional: pre-fill command generator login info with config info for convenience
                            if (!this.cmd.loginUrl)
                                this.cmd.loginUrl = this.config.ikuaiUrl;
                            if (!this.cmd.loginUser)
                                this.cmd.loginUser = this.config.username;
                            if (!this.cmd.loginPass)
                                this.cmd.loginPass = this.config.password;
                        } catch (e) {
                            console.log(
                                "Not running in server mode or fetch failed:",
                                e,
                            );
                        }
                    },

                    async saveConfig() {
                        try {
                            // Construct the payload matching the Go struct JSON tags
                            const payload = {
                                "ikuai-url": this.config.ikuaiUrl,
                                username: this.config.username,
                                password: this.config.password,
                                cron: this.config.cron,
                                AddErrRetryWait:
                                    this.config.addErrRetryWait.endsWith("s")
                                        ? parseInt(
                                              this.config.addErrRetryWait,
                                          ) * 1000000000
                                        : 10000000000, // naive conv
                                AddWait: this.config.addWait.endsWith("s")
                                    ? parseInt(this.config.addWait) * 1000000000
                                    : 1000000000,
                                webui: {
                                    enable: this.config.webui.enable,
                                    port: this.config.webui.port,
                                    user: this.config.webui.user,
                                    pass: this.config.webui.pass,
                                    "cdn-prefix": this.config.webui.cdnPrefix,
                                },
                                "custom-isp": this.config.customIsp,
                                "stream-domain": this.config.streamDomain.map(
                                    (x) => ({
                                        interface: x.interface,
                                        "src-addr": x.srcAddr,
                                        url: x.url,
                                        tag: x.tag,
                                    }),
                                ),
                                "ip-group": this.config.ipGroup,
                                "ipv6-group": this.config.ipv6Group,
                                "stream-ipport": this.config.streamIpPort.map(
                                    (x) => ({
                                        type: String(x.type),
                                        interface: x.interface,
                                        nexthop: x.nexthop,
                                        "src-addr": x.srcAddr,
                                        "ip-group": x.ipGroup,
                                        mode: parseInt(x.mode),
                                        ifaceband: parseInt(x.ifaceband),
                                    }),
                                ),
                            };

                            // Hack: JSON unmarshal in Go for time.Duration expects number (ns) usually if no custom unmarshaler,
                            // OR string "10s" if using yaml/json unmarshaler that supports it.
                            // Since we are sending JSON to a handler that uses json.Decoder, we should send appropriate format.
                            // Let's rely on string format if the backend supports it, otherwise numbers.
                            // The Go standard lib json unmarshal for time.Duration expects Nanoseconds (int64).
                            // Let's fix the payload to send strings and hope user doesn't break it, or send NS.
                            // To be safe, let's just send the strings and handle them in backend?
                            // Wait, standard `json` package does NOT support "10s" string for time.Duration. It expects int64 nanoseconds.
                            // However, `gopkg.in/yaml.v3` DOES support strings.
                            // BUT our API endpoint uses `json.NewDecoder`.
                            // We should probably change the backend to custom decode or use a struct with proper tags or just strings.
                            // For now, let's send Nanoseconds to be safe with standard JSON.
                            payload.AddErrRetryWait =
                                parseInt(this.config.addErrRetryWait) *
                                1000000000;
                            payload.AddWait =
                                parseInt(this.config.addWait) * 1000000000;

                            const res = await fetch("/api/save", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload),
                            });

                            if (res.ok) {
                                alert("保存成功！Server config updated.");
                            } else {
                                const txt = await res.text();
                                alert("保存失败: " + txt);
                            }
                        } catch (e) {
                            alert("保存错误: " + e);
                        }
                    },

                    get generatedCommand() {
                        let exe = this.cmd.exePath;
                        // 简单处理路径中的空格
                        if (exe.includes(" ")) exe = `"${exe}"`;

                        let c = `${exe} -c ${this.cmd.configPath} -r ${this.cmd.runMode}`;
                        if (
                            this.cmd.runMode !== "clean" &&
                            this.cmd.runMode !== "exportDomainSteamToTxt" &&
                            this.cmd.runMode !== "web"
                        ) {
                            c += ` -m ${this.cmd.module}`;
                        }

                        if (this.cmd.runMode === "clean" && this.cmd.cleanTag) {
                            c += ` -tag ${this.cmd.cleanTag}`;
                        }

                        if (this.cmd.useCustomLogin && this.cmd.loginUrl) {
                            c += ` -login "${this.cmd.loginUrl},${this.cmd.loginUser},${this.cmd.loginPass}"`;
                        }

                        if (this.cmd.delOldRule !== "after") {
                            c += ` -delOldRule ${this.cmd.delOldRule}`;
                        }

                        if (
                            this.cmd.module.includes("ip") &&
                            this.cmd.randomSuff !== "1"
                        ) {
                            c += ` -isIpGroupNameAddRandomSuff ${this.cmd.randomSuff}`;
                        }

                        return c;
                    },

                    get runModeDescription() {
                        const descriptions = {
                            cron: "计划任务模式。程序启动后会立即执行一次分流规则更新，随后根据配置文件中的 cron 表达式进入定时等待模式，并在后台持续运行。",
                            cronAft:
                                "延迟计划任务模式。程序启动后不会立即执行更新，而是直接根据 cron 表达式进入定时等待状态。适合在系统重启后不想立即占用大量带宽的场景。",
                            once: "单次运行模式。程序会立即执行一次完整的分流规则同步任务，执行完成后会自动退出。适合配合系统的 crontab 外部调度使用。",
                            web: "WebUI 模式。仅启动可视化配置界面，不执行任何分流同步任务。适合在需要安全修改配置文件时临时使用。",
                            clean: "清理模式。程序将连接爱快并删除所有备注中包含指定标签（默认为 IKUAI_BYPASS_）的分流规则。用于彻底移除本工具创建的配置。",
                            exportDomainSteamToTxt:
                                "导出模式。将配置文件中定义的域名分流规则转换并导出为爱快支持的手动导入 TXT 格式，导出路径可通过 -exportPath 指定。",
                        };
                        return (
                            descriptions[this.cmd.runMode] ||
                            "请选择运行模式查看详细说明。"
                        );
                    },

                    get generatedYaml() {
                        // Filter empty objects
                        const cleanConfig = {
                            "ikuai-url": this.config.ikuaiUrl,
                            username: this.config.username,
                            password: this.config.password,
                            cron: this.config.cron,
                            AddErrRetryWait: this.config.addErrRetryWait,
                            AddWait: this.config.addWait,
                        };

                        if (
                            this.config.webui.enable ||
                            this.config.webui.port ||
                            this.config.webui.user ||
                            this.config.webui.cdnPrefix
                        ) {
                            cleanConfig["webui"] = {
                                enable: this.config.webui.enable,
                                port: this.config.webui.port,
                                user: this.config.webui.user,
                                pass: this.config.webui.pass,
                                "cdn-prefix": this.config.webui.cdnPrefix,
                            };
                        }

                        if (this.config.customIsp.length > 0)
                            cleanConfig["custom-isp"] = this.config.customIsp;
                        if (this.config.streamDomain.length > 0)
                            cleanConfig["stream-domain"] =
                                this.config.streamDomain.map((x) => {
                                    const obj = {
                                        interface: x.interface,
                                        "src-addr": x.srcAddr,
                                        url: x.url,
                                    };
                                    if (x.tag) obj.tag = x.tag;
                                    return obj;
                                });
                        if (this.config.ipGroup.length > 0)
                            cleanConfig["ip-group"] = this.config.ipGroup;
                        if (this.config.ipv6Group.length > 0)
                            cleanConfig["ipv6-group"] = this.config.ipv6Group;

                        if (this.config.streamIpPort.length > 0) {
                            cleanConfig["stream-ipport"] =
                                this.config.streamIpPort.map((item) => {
                                    const obj = {
                                        type: parseInt(item.type), // ensure number
                                        "src-addr": item.srcAddr,
                                        "ip-group": item.ipGroup,
                                        mode: parseInt(item.mode),
                                        ifaceband: parseInt(item.ifaceband),
                                    };
                                    if (item.type == "0")
                                        obj.interface = item.interface;
                                    if (item.type == "1")
                                        obj.nexthop = item.nexthop;
                                    return obj;
                                });
                        }

                        return jsyaml.dump(cleanConfig, { lineWidth: -1 }); // prevent line folding
                    },

                    addItem(arrayName) {
                        if (arrayName === "customIsp")
                            this.config.customIsp.push({
                                name: "",
                                url: "",
                                tag: "",
                            });
                        if (arrayName === "streamDomain")
                            this.config.streamDomain.push({
                                interface: "wan1",
                                srcAddr: "",
                                url: "",
                                tag: "",
                            });
                        if (arrayName === "ipGroup")
                            this.config.ipGroup.push({ name: "", url: "" });
                        if (arrayName === "ipv6Group")
                            this.config.ipv6Group.push({ name: "", url: "" });
                        if (arrayName === "streamIpPort")
                            this.config.streamIpPort.push({
                                type: "0",
                                interface: "wan1",
                                nexthop: "",
                                srcAddr: "",
                                ipGroup: "",
                                mode: 0,
                                ifaceband: 0,
                            });
                    },

                    removeItem(arrayName, index) {
                        this.config[arrayName].splice(index, 1);
                    },

                    async copyToClipboard(text) {
                        try {
                            await navigator.clipboard.writeText(text);
                            alert("已复制到剪贴板！");
                        } catch (err) {
                            console.error("Failed to copy!", err);
                        }
                    },
                };
            }
        </script>
    </body>
</html>
