<!doctype html>
<html lang="zh-CN" class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>iKuai Bypass 配置助手</title>

        <script src="{{CDN_PREFIX}}/@tailwindcss/browser@4"></script>
        <style type="text/tailwindcss">
            @theme {
                /* Map primary to blue */
                --color-primary-50: var(--color-blue-50);
                --color-primary-100: var(--color-blue-100);
                --color-primary-200: var(--color-blue-200);
                --color-primary-300: var(--color-blue-300);
                --color-primary-400: var(--color-blue-400);
                --color-primary-500: var(--color-blue-500);
                --color-primary-600: var(--color-blue-600);
                --color-primary-700: var(--color-blue-700);
                --color-primary-800: var(--color-blue-800);
                --color-primary-900: var(--color-blue-900);
                --color-primary-950: var(--color-blue-950);

                /* Map gray to slate */
                --color-gray-50: var(--color-slate-50);
                --color-gray-100: var(--color-slate-100);
                --color-gray-200: var(--color-slate-200);
                --color-gray-300: var(--color-slate-300);
                --color-gray-400: var(--color-slate-400);
                --color-gray-500: var(--color-slate-500);
                --color-gray-600: var(--color-slate-600);
                --color-gray-700: var(--color-slate-700);
                --color-gray-800: var(--color-slate-800);
                --color-gray-900: var(--color-slate-900);
                --color-gray-950: var(--color-slate-950);
            }

            /* Enable class-based dark mode */
            @custom-variant dark (&:where(.dark, .dark *));
        </style>

        <!-- 2. Bootstrap Icons -->
        <link
            rel="stylesheet"
            href="{{CDN_PREFIX}}/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />

        <!-- 3. JS-YAML -->
        <script src="{{CDN_PREFIX}}/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

        <!-- 4. Alpine.js -->
        <script
            defer
            src="{{CDN_PREFIX}}/alpinejs@3.13.3/dist/cdn.min.js"
        ></script>

        <style>
            [x-cloak] {
                display: none !important;
            }
            /* 自定义滚动条样式，适配深色模式 */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 4px;
            }
            .dark ::-webkit-scrollbar-thumb {
                background: #475569;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            .dark ::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }
        </style>
    </head>
    <body
        class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200"
        x-data="app()"
        x-init="initApp()"
    >
        <!-- 顶部导航栏 -->
        <header
            class="sticky top-0 z-50 w-full bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 shadow-sm transition-colors duration-200"
        >
            <div
                class="container mx-auto px-4 h-16 flex items-center justify-between"
            >
                <div class="flex items-center gap-3">
                    <i
                        class="bi bi-router text-2xl text-primary-600 dark:text-primary-400"
                    ></i>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">
                            iKuai Bypass
                        </h1>
                        <p
                            class="text-[10px] text-gray-500 dark:text-gray-400 font-mono"
                        >
                            配置助手 & 规则同步
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <!-- 主题切换组件 -->
                    <div
                        class="flex items-center p-1 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600"
                    >
                        <button
                            @click="setTheme('light')"
                            :class="theme === 'light' ? 'bg-white dark:bg-gray-600 text-primary-600 dark:text-primary-300 shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'"
                            class="p-1.5 rounded-md transition-all duration-200"
                            title="明亮模式"
                        >
                            <i class="bi bi-sun-fill text-sm"></i>
                        </button>
                        <button
                            @click="setTheme('dark')"
                            :class="theme === 'dark' ? 'bg-white dark:bg-gray-600 text-primary-600 dark:text-primary-300 shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'"
                            class="p-1.5 rounded-md transition-all duration-200"
                            title="暗黑模式"
                        >
                            <i class="bi bi-moon-stars-fill text-sm"></i>
                        </button>
                        <button
                            @click="setTheme('auto')"
                            :class="theme === 'auto' ? 'bg-white dark:bg-gray-600 text-primary-600 dark:text-primary-300 shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'"
                            class="p-1.5 rounded-md transition-all duration-200"
                            title="跟随系统"
                        >
                            <i class="bi bi-display text-sm"></i>
                        </button>
                    </div>

                    <a
                        href="https://github.com/joyanhui/ikuai-bypass"
                        target="_blank"
                        class="hidden md:flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors"
                    >
                        <i class="bi bi-github"></i> GitHub
                    </a>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Tab 切换 -->
            <div class="mb-8 border-b border-gray-200 dark:border-gray-700">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button
                        @click="currentTab = 'help'"
                        :class="currentTab === 'help'
                            ? 'border-primary-500 text-primary-600 dark:text-primary-400'
                            : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2 transition-colors"
                    >
                        <i class="bi bi-book"></i> 使用说明
                    </button>
                    <button
                        @click="currentTab = 'config'"
                        :class="currentTab === 'config'
                            ? 'border-primary-500 text-primary-600 dark:text-primary-400'
                            : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2 transition-colors"
                    >
                        <i class="bi bi-sliders"></i> 配置助手
                    </button>
                </nav>
            </div>

            <!-- Tab 内容区 -->
            <div class="min-h-[60vh]">
                <!-- 1. 使用说明 Tab -->
                <div
                    x-show="currentTab === 'help'"
                    x-transition:enter.opacity.duration.300ms
                >
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- 快速指引卡片 -->
                        <div
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                        >
                            <div
                                class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 flex items-center justify-center mb-4 text-xl font-bold"
                            >
                                1
                            </div>
                            <h3 class="text-lg font-bold mb-2">填写配置</h3>
                            <p
                                class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed"
                            >
                                切换到“配置助手”标签页，填入您的爱快路由器地址、账号密码，并根据需求添加分流规则（IP分组、域名分流等）。
                            </p>
                        </div>
                        <div
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                        >
                            <div
                                class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400 flex items-center justify-center mb-4 text-xl font-bold"
                            >
                                2
                            </div>
                            <h3 class="text-lg font-bold mb-2">保存并运行</h3>
                            <p
                                class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed"
                            >
                                点击“保存到服务器”更新配置文件。然后使用生成的命令在终端运行程序，或将其添加到系统的
                                Crontab 计划任务中。
                            </p>
                        </div>
                    </div>

                    <div
                        class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-5 mb-8"
                    >
                        <h4
                            class="text-yellow-800 dark:text-yellow-200 font-bold mb-2 flex items-center gap-2"
                        >
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            注意事项
                        </h4>
                        <ul
                            class="list-disc list-inside text-sm text-yellow-700 dark:text-yellow-300 space-y-1"
                        >
                            <li>
                                请勿将本服务的 WebUI
                                端口暴露在公网，以免账号泄露。
                            </li>
                            <li>
                                修改带有
                                <span class="text-red-500 font-bold">*</span>
                                标记的配置项需要重启本程序才能生效。
                            </li>
                            <li>
                                推荐使用 Chrome 或 Edge 浏览器以获得最佳体验。
                            </li>
                        </ul>
                    </div>

                    <div class="text-center">
                        <button
                            @click="currentTab = 'config'"
                            class="px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-bold shadow-md transition-transform transform hover:-translate-y-0.5"
                        >
                            开始配置
                        </button>
                    </div>
                </div>

                <!-- 2. 配置助手 Tab -->
                <div x-show="currentTab === 'config'" x-cloak>
                    <!-- 顶部：运行命令生成器 -->
                    <section
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8"
                    >
                        <h2
                            class="text-lg font-bold mb-4 flex items-center gap-2 border-b border-gray-100 dark:border-gray-700 pb-3"
                        >
                            <i class="bi bi-terminal-fill text-gray-500"></i>
                            运行命令生成器
                        </h2>

                        <div
                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"
                        >
                            <!-- 运行模式 -->
                            <div class="space-y-1">
                                <label
                                    class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase"
                                    >运行模式 (-r)</label
                                >
                                <select
                                    x-model="cmd.runMode"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm rounded-lg p-2.5 focus:ring-primary-500 focus:border-primary-500 dark:text-white"
                                >
                                    <option value="cron">
                                        cron (计划任务)
                                    </option>
                                    <option value="cronAft">
                                        cronAft (延迟计划)
                                    </option>
                                    <option value="once">
                                        once (单次运行)
                                    </option>
                                    <option value="clean">
                                        clean (清理规则)
                                    </option>
                                    <option value="web">web (仅WebUI)</option>
                                </select>
                            </div>

                            <!-- 配置文件 -->
                            <div class="space-y-1">
                                <label
                                    class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase"
                                    >配置文件 (-c)</label
                                >
                                <input
                                    type="text"
                                    x-model="cmd.configPath"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm rounded-lg p-2.5 focus:ring-primary-500 focus:border-primary-500 dark:text-white"
                                />
                            </div>

                            <!-- 功能模块 -->
                            <div class="space-y-1">
                                <label
                                    class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase"
                                    >功能模块 (-m)</label
                                >
                                <select
                                    x-model="cmd.module"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm rounded-lg p-2.5 focus:ring-primary-500 focus:border-primary-500 dark:text-white"
                                >
                                    <option value="ispdomain">
                                        ispdomain (域名+ISP)
                                    </option>
                                    <option value="ipgroup">
                                        ipgroup (IP分组+端口)
                                    </option>
                                    <option value="ipv6group">
                                        ipv6group (IPv6分组)
                                    </option>
                                    <option value="ii">ii (混合模式)</option>
                                    <option value="ip">ip (v4+v6分组)</option>
                                </select>
                            </div>

                            <!-- 选项 -->
                            <div class="space-y-1">
                                <label
                                    class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase"
                                    >旧规则删除</label
                                >
                                <select
                                    x-model="cmd.delOldRule"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm rounded-lg p-2.5 focus:ring-primary-500 focus:border-primary-500 dark:text-white"
                                >
                                    <option value="after">
                                        After (成功后删)
                                    </option>
                                    <option value="before">
                                        Before (更新前删)
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- 生成结果 -->
                        <div class="relative group">
                            <div
                                class="bg-gray-900 dark:bg-black rounded-lg p-4 font-mono text-sm text-green-400 break-all border border-gray-800"
                                x-text="generatedCmd"
                            ></div>
                            <button
                                @click="copyText(generatedCmd)"
                                class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/10 hover:bg-white/20 text-white text-xs px-2 py-1 rounded"
                            >
                                复制
                            </button>
                        </div>
                    </section>

                    <!-- 核心：配置文件编辑器 -->
                    <form @submit.prevent="saveConfig" class="space-y-8">
                        <!-- 基础配置 -->
                        <section
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                        >
                            <div
                                class="flex items-center justify-between mb-4 border-b border-gray-100 dark:border-gray-700 pb-2"
                            >
                                <h3
                                    class="text-lg font-bold flex items-center gap-2"
                                >
                                    <i
                                        class="bi bi-gear-fill text-primary-600"
                                    ></i>
                                    基础配置
                                </h3>
                                <button
                                    type="button"
                                    @click="loadRemoteConfig"
                                    class="text-xs text-primary-600 dark:text-primary-400 hover:underline flex items-center gap-1"
                                >
                                    <i class="bi bi-cloud-arrow-down"></i> 从
                                    URL 加载示例
                                </button>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                                        >爱快地址 (URL)</label
                                    >
                                    <input
                                        type="text"
                                        x-model="config.ikuaiUrl"
                                        placeholder="http://192.168.1.1"
                                        class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                                    />
                                </div>
                                <div>
                                    <label
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                                        >Cron 表达式
                                        <span class="text-red-500 text-xs"
                                            >*</span
                                        ></label
                                    >
                                    <input
                                        type="text"
                                        x-model="config.cron"
                                        placeholder="0 7 * * *"
                                        class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                                    />
                                </div>
                                <div>
                                    <label
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                                        >用户名</label
                                    >
                                    <input
                                        type="text"
                                        x-model="config.username"
                                        class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                                    />
                                </div>
                                <div>
                                    <label
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                                        >密码</label
                                    >
                                    <input
                                        type="password"
                                        x-model="config.password"
                                        class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                                    />
                                </div>
                            </div>
                        </section>

                        <!-- 自定义运营商 -->
                        <section
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                        >
                            <div class="flex justify-between items-center mb-4">
                                <h3
                                    class="text-lg font-bold flex items-center gap-2"
                                >
                                    <i class="bi bi-globe text-indigo-500"></i>
                                    自定义运营商
                                </h3>
                                <button
                                    type="button"
                                    @click="addItem('customIsp')"
                                    class="px-3 py-1.5 text-xs font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transition-colors"
                                >
                                    + 添加规则
                                </button>
                            </div>

                            <div class="space-y-3">
                                <template
                                    x-for="(item, index) in config.customIsp"
                                    :key="index"
                                >
                                    <div
                                        class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg border border-gray-100 dark:border-gray-700"
                                    >
                                        <div class="md:col-span-3">
                                            <input
                                                type="text"
                                                x-model="item.name"
                                                placeholder="运营商名称"
                                                class="w-full text-sm bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:text-white px-2 py-1.5"
                                            />
                                        </div>
                                        <div class="md:col-span-6">
                                            <input
                                                type="text"
                                                x-model="item.url"
                                                placeholder="IP列表 URL"
                                                class="w-full text-sm bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:text-white px-2 py-1.5"
                                            />
                                        </div>
                                        <div class="md:col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.tag"
                                                placeholder="标签"
                                                class="w-full text-sm bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:text-white px-2 py-1.5"
                                            />
                                        </div>
                                        <div class="md:col-span-1 text-right">
                                            <button
                                                type="button"
                                                @click="removeItem('customIsp', index)"
                                                class="text-red-500 hover:text-red-700 dark:hover:text-red-400 p-1"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <div
                                    x-show="config.customIsp.length === 0"
                                    class="text-center py-4 text-gray-400 text-sm italic bg-gray-50 dark:bg-gray-900/30 rounded-lg"
                                >
                                    暂无规则，点击上方按钮添加
                                </div>
                            </div>
                        </section>

                        <!-- IP 分组 -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- IPv4 Group -->
                            <section
                                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                            >
                                <div
                                    class="flex justify-between items-center mb-4"
                                >
                                    <h3
                                        class="text-lg font-bold flex items-center gap-2"
                                    >
                                        <i
                                            class="bi bi-collection text-teal-500"
                                        ></i>
                                        IP 分组 (v4)
                                    </h3>
                                    <button
                                        type="button"
                                        @click="addItem('ipGroup')"
                                        class="px-2 py-1 text-xs bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 rounded hover:bg-teal-200 transition-colors"
                                    >
                                        + 添加
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <template
                                        x-for="(item, index) in config.ipGroup"
                                        :key="index"
                                    >
                                        <div
                                            class="bg-gray-50 dark:bg-gray-900/50 p-2 rounded border border-gray-100 dark:border-gray-700 space-y-2"
                                        >
                                            <input
                                                type="text"
                                                x-model="item.name"
                                                placeholder="分组名称"
                                                class="w-full text-xs font-bold bg-transparent border-none p-0 focus:ring-0 text-gray-800 dark:text-gray-200"
                                            />
                                            <div class="flex gap-2">
                                                <input
                                                    type="text"
                                                    x-model="item.url"
                                                    placeholder="http://..."
                                                    class="flex-1 text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded px-2 py-1 dark:text-gray-300"
                                                />
                                                <button
                                                    type="button"
                                                    @click="removeItem('ipGroup', index)"
                                                    class="text-red-400 hover:text-red-600"
                                                >
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </section>

                            <!-- IPv6 Group -->
                            <section
                                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                            >
                                <div
                                    class="flex justify-between items-center mb-4"
                                >
                                    <h3
                                        class="text-lg font-bold flex items-center gap-2"
                                    >
                                        <i
                                            class="bi bi-collection-fill text-purple-500"
                                        ></i>
                                        IPv6 分组
                                    </h3>
                                    <button
                                        type="button"
                                        @click="addItem('ipv6Group')"
                                        class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded hover:bg-purple-200 transition-colors"
                                    >
                                        + 添加
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <template
                                        x-for="(item, index) in config.ipv6Group"
                                        :key="index"
                                    >
                                        <div
                                            class="bg-gray-50 dark:bg-gray-900/50 p-2 rounded border border-gray-100 dark:border-gray-700 space-y-2"
                                        >
                                            <input
                                                type="text"
                                                x-model="item.name"
                                                placeholder="分组名称"
                                                class="w-full text-xs font-bold bg-transparent border-none p-0 focus:ring-0 text-gray-800 dark:text-gray-200"
                                            />
                                            <div class="flex gap-2">
                                                <input
                                                    type="text"
                                                    x-model="item.url"
                                                    placeholder="http://..."
                                                    class="flex-1 text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded px-2 py-1 dark:text-gray-300"
                                                />
                                                <button
                                                    type="button"
                                                    @click="removeItem('ipv6Group', index)"
                                                    class="text-red-400 hover:text-red-600"
                                                >
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </section>
                        </div>

                        <!-- 域名分流 -->
                        <section
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                        >
                            <div class="flex justify-between items-center mb-4">
                                <h3
                                    class="text-lg font-bold flex items-center gap-2"
                                >
                                    <i
                                        class="bi bi-signpost-split text-orange-500"
                                    ></i>
                                    域名分流
                                </h3>
                                <button
                                    type="button"
                                    @click="addItem('streamDomain')"
                                    class="px-3 py-1.5 text-xs font-medium text-white bg-orange-500 rounded-lg hover:bg-orange-600 transition-colors"
                                >
                                    + 添加规则
                                </button>
                            </div>
                            <div class="space-y-3">
                                <template
                                    x-for="(item, index) in config.streamDomain"
                                    :key="index"
                                >
                                    <div
                                        class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg border border-gray-100 dark:border-gray-700 grid gap-3 md:grid-cols-12 relative group"
                                    >
                                        <button
                                            type="button"
                                            @click="removeItem('streamDomain', index)"
                                            class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <i class="bi bi-trash-fill"></i>
                                        </button>

                                        <div class="md:col-span-2">
                                            <label
                                                class="text-[10px] text-gray-500 uppercase font-bold"
                                                >接口</label
                                            >
                                            <input
                                                type="text"
                                                x-model="item.interface"
                                                class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white px-2 py-1"
                                            />
                                        </div>
                                        <div class="md:col-span-3">
                                            <label
                                                class="text-[10px] text-gray-500 uppercase font-bold"
                                                >源地址</label
                                            >
                                            <input
                                                type="text"
                                                x-model="item.srcAddr"
                                                placeholder="192.168.1.5"
                                                class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white px-2 py-1"
                                            />
                                        </div>
                                        <div class="md:col-span-5">
                                            <label
                                                class="text-[10px] text-gray-500 uppercase font-bold"
                                                >域名列表 URL</label
                                            >
                                            <input
                                                type="text"
                                                x-model="item.url"
                                                class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white px-2 py-1"
                                            />
                                        </div>
                                        <div class="md:col-span-2">
                                            <label
                                                class="text-[10px] text-gray-500 uppercase font-bold"
                                                >Tag</label
                                            >
                                            <input
                                                type="text"
                                                x-model="item.tag"
                                                class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white px-2 py-1"
                                            />
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </section>

                        <!-- 端口分流 -->
                        <section
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"
                        >
                            <div class="flex justify-between items-center mb-4">
                                <h3
                                    class="text-lg font-bold flex items-center gap-2"
                                >
                                    <i class="bi bi-usb-plug text-pink-500"></i>
                                    端口分流
                                </h3>
                                <button
                                    type="button"
                                    @click="addItem('streamIpPort')"
                                    class="px-3 py-1.5 text-xs font-medium text-white bg-pink-500 rounded-lg hover:bg-pink-600 transition-colors"
                                >
                                    + 添加规则
                                </button>
                            </div>
                            <div class="space-y-4">
                                <template
                                    x-for="(item, index) in config.streamIpPort"
                                    :key="index"
                                >
                                    <div
                                        class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg border border-gray-100 dark:border-gray-700 relative group"
                                    >
                                        <button
                                            type="button"
                                            @click="removeItem('streamIpPort', index)"
                                            class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <i class="bi bi-trash-fill"></i>
                                        </button>

                                        <div
                                            class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3"
                                        >
                                            <div>
                                                <label
                                                    class="text-[10px] text-gray-500 uppercase font-bold block mb-1"
                                                    >分流类型</label
                                                >
                                                <select
                                                    x-model="item.type"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                >
                                                    <option value="0">
                                                        外网线路
                                                    </option>
                                                    <option value="1">
                                                        下一跳网关
                                                    </option>
                                                </select>
                                            </div>
                                            <div>
                                                <label
                                                    class="text-[10px] text-gray-500 uppercase font-bold block mb-1"
                                                    x-text="item.type == '0' ? '接口名称' : '下一跳 IP'"
                                                ></label>
                                                <input
                                                    x-show="item.type == '0'"
                                                    type="text"
                                                    x-model="item.interface"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                />
                                                <input
                                                    x-show="item.type == '1'"
                                                    type="text"
                                                    x-model="item.nexthop"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                />
                                            </div>
                                            <div>
                                                <label
                                                    class="text-[10px] text-gray-500 uppercase font-bold block mb-1"
                                                    >IP分组名</label
                                                >
                                                <input
                                                    type="text"
                                                    x-model="item.ipGroup"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                />
                                            </div>
                                        </div>
                                        <div
                                            class="grid grid-cols-1 md:grid-cols-3 gap-4"
                                        >
                                            <div>
                                                <label
                                                    class="text-[10px] text-gray-500 uppercase font-bold block mb-1"
                                                    >源地址</label
                                                >
                                                <input
                                                    type="text"
                                                    x-model="item.srcAddr"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                />
                                            </div>
                                            <div>
                                                <label
                                                    class="text-[10px] text-gray-500 uppercase font-bold block mb-1"
                                                    >负载模式</label
                                                >
                                                <select
                                                    x-model="item.mode"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                >
                                                    <option value="0">
                                                        0-新建连接数
                                                    </option>
                                                    <option value="1">
                                                        1-源IP
                                                    </option>
                                                    <option value="2">
                                                        2-源IP+源端口
                                                    </option>
                                                    <option value="3">
                                                        3-源IP+目的IP
                                                    </option>
                                                </select>
                                            </div>
                                            <div>
                                                <label
                                                    class="text-[10px] text-gray-500 uppercase font-bold block mb-1"
                                                    >线路绑定</label
                                                >
                                                <select
                                                    x-model="item.ifaceband"
                                                    class="w-full text-sm rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 dark:text-white p-2"
                                                >
                                                    <option value="0">
                                                        0-不绑定
                                                    </option>
                                                    <option value="1">
                                                        1-绑定
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </section>

                        <!-- 操作栏 -->
                        <div
                            class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur border-t border-gray-200 dark:border-gray-700 shadow-lg z-40"
                        >
                            <div
                                class="container mx-auto flex justify-between items-center max-w-6xl"
                            >
                                <div
                                    class="text-xs text-gray-500 dark:text-gray-400"
                                >
                                    <span
                                        x-show="saveStatus"
                                        x-text="saveStatus"
                                        class="mr-2 px-2 py-1 rounded bg-gray-100 dark:bg-gray-700"
                                    ></span>
                                </div>
                                <div class="flex gap-4">
                                    <button
                                        type="button"
                                        @click="showPreview = !showPreview"
                                        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                                    >
                                        <i class="bi bi-eye"></i> 预览配置
                                    </button>
                                    <button
                                        type="submit"
                                        class="px-6 py-2 text-sm font-bold text-white bg-primary-600 rounded-lg hover:bg-primary-700 shadow-lg shadow-primary-500/30 transition-all"
                                    >
                                        <i class="bi bi-save"></i> 保存配置
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="h-16"></div>
                        <!-- Spacer for fixed footer -->
                    </form>

                    <!-- YAML 预览模态框 -->
                    <div
                        x-show="showPreview"
                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
                        x-cloak
                    >
                        <div
                            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col"
                            @click.away="showPreview = false"
                        >
                            <div
                                class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700"
                            >
                                <h3 class="font-bold">config.yml 预览</h3>
                                <button
                                    @click="showPreview = false"
                                    class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
                                >
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <div class="flex-1 overflow-auto p-0 bg-gray-900">
                                <textarea
                                    readonly
                                    x-model="generatedYaml"
                                    class="w-full h-full bg-gray-900 text-gray-200 font-mono text-xs p-4 focus:outline-none resize-none"
                                ></textarea>
                            </div>
                            <div
                                class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2"
                            >
                                <button
                                    @click="copyText(generatedYaml)"
                                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600"
                                >
                                    复制
                                </button>
                                <button
                                    @click="showPreview = false"
                                    class="px-4 py-2 bg-primary-600 text-white rounded text-sm hover:bg-primary-700"
                                >
                                    关闭
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            function app() {
                return {
                    theme: localStorage.getItem("theme") || "auto",
                    currentTab: "help",
                    showPreview: false,
                    saveStatus: "",

                    // 命令生成相关
                    cmd: {
                        exePath: "{{EXE_PATH}}", // 占位符
                        configPath: "{{CONF_PATH}}", // 占位符
                        runMode: "cron",
                        module: "ispdomain",
                        delOldRule: "after",
                    },

                    // 核心配置数据
                    config: {
                        ikuaiUrl: "",
                        username: "",
                        password: "",
                        cron: "",
                        customIsp: [],
                        streamDomain: [],
                        ipGroup: [],
                        ipv6Group: [],
                        streamIpPort: [],
                        webui: {
                            enable: false,
                            port: "8080",
                            user: "",
                            pass: "",
                            cdnPrefix: "",
                        },
                        addErrRetryWait: "10s",
                        addWait: "1s",
                    },

                    initApp() {
                        this.applyTheme();
                        // 监听系统主题变化
                        window
                            .matchMedia("(prefers-color-scheme: dark)")
                            .addEventListener("change", () => {
                                if (this.theme === "auto") this.applyTheme();
                            });

                        // 加载后端配置
                        this.loadBackendConfig();
                    },

                    // 主题切换逻辑
                    setTheme(val) {
                        this.theme = val;
                        localStorage.setItem("theme", val);
                        this.applyTheme();
                    },

                    applyTheme() {
                        const isDark =
                            this.theme === "dark" ||
                            (this.theme === "auto" &&
                                window.matchMedia(
                                    "(prefers-color-scheme: dark)",
                                ).matches);
                        if (isDark) {
                            document.documentElement.classList.add("dark");
                        } else {
                            document.documentElement.classList.remove("dark");
                        }
                    },

                    // API: 加载配置
                    async loadBackendConfig() {
                        try {
                            const res = await fetch("/api/config");
                            if (!res.ok) throw new Error("API Error");
                            const data = await res.json();

                            // 映射数据到本地模型
                            this.cmd.exePath =
                                data.exe_path || this.cmd.exePath;
                            // 注意：serverConfPath 如果有的话可以更新 cmd.configPath，这里暂且保留默认或占位符

                            this.config.ikuaiUrl = data["ikuai-url"] || "";
                            this.config.username = data.username || "";
                            this.config.password = data.password || "";
                            this.config.cron = data.cron || "";

                            // 数组处理，防止 null
                            this.config.customIsp = (
                                data["custom-isp"] || []
                            ).map((i) => ({
                                name: i.name,
                                url: i.url,
                                tag: i.tag,
                            }));
                            this.config.streamDomain = (
                                data["stream-domain"] || []
                            ).map((i) => ({
                                interface: i.interface,
                                srcAddr: i["src-addr"],
                                url: i.url,
                                tag: i.tag,
                            }));
                            this.config.ipGroup = (data["ip-group"] || []).map(
                                (i) => ({ name: i.name, url: i.url }),
                            );
                            this.config.ipv6Group = (
                                data["ipv6-group"] || []
                            ).map((i) => ({ name: i.name, url: i.url }));
                            this.config.streamIpPort = (
                                data["stream-ipport"] || []
                            ).map((i) => ({
                                type: String(i.type),
                                interface: i.interface,
                                nexthop: i.nexthop,
                                srcAddr: i["src-addr"],
                                ipGroup: i["ip-group"],
                                mode: String(i.mode || 0),
                                ifaceband: String(i.ifaceband || 0),
                            }));

                            // WebUI & 高级设置
                            if (data.webui) {
                                this.config.webui = {
                                    enable: !!data.webui.enable,
                                    port: String(data.webui.port),
                                    user: data.webui.user || "",
                                    pass: data.webui.pass || "",
                                    cdnPrefix: data.webui["cdn-prefix"],
                                };
                            }
                            if (data.AddErrRetryWait)
                                this.config.addErrRetryWait =
                                    String(data.AddErrRetryWait / 1e9) + "s";
                            if (data.AddWait)
                                this.config.addWait =
                                    String(data.AddWait / 1e9) + "s";
                        } catch (e) {
                            console.error("加载配置失败", e);
                            this.saveStatus = "加载配置失败: " + e.message;
                        }
                    },

                    // API: 保存配置
                    async saveConfig() {
                        this.saveStatus = "正在保存...";
                        try {
                            // 构造后端需要的 JSON 结构
                            const payload = {
                                "ikuai-url": this.config.ikuaiUrl,
                                username: this.config.username,
                                password: this.config.password,
                                cron: this.config.cron,
                                AddErrRetryWait: parseInt(
                                    parseFloat(this.config.addErrRetryWait) *
                                        1e9,
                                ),
                                AddWait: parseInt(
                                    parseFloat(this.config.addWait) * 1e9,
                                ),
                                webui: {
                                    enable: this.config.webui.enable,
                                    port: this.config.webui.port,
                                    user: this.config.webui.user,
                                    pass: this.config.webui.pass,
                                    "cdn-prefix": this.config.webui.cdnPrefix,
                                },
                                "custom-isp": this.config.customIsp,
                                "stream-domain": this.config.streamDomain.map(
                                    (i) => ({
                                        interface: i.interface,
                                        "src-addr": i.srcAddr,
                                        url: i.url,
                                        tag: i.tag,
                                    }),
                                ),
                                "ip-group": this.config.ipGroup,
                                "ipv6-group": this.config.ipv6Group,
                                "stream-ipport": this.config.streamIpPort.map(
                                    (i) => ({
                                        type: parseInt(i.type),
                                        interface: i.interface,
                                        nexthop: i.nexthop,
                                        "src-addr": i.srcAddr,
                                        "ip-group": i.ipGroup,
                                        mode: parseInt(i.mode),
                                        ifaceband: parseInt(i.ifaceband),
                                    }),
                                ),
                                with_comments: true, // 请求保留注释
                            };

                            const res = await fetch("/api/save", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload),
                            });

                            if (res.ok) {
                                this.saveStatus =
                                    "保存成功！" +
                                    new Date().toLocaleTimeString();
                                setTimeout(() => (this.saveStatus = ""), 3000);
                            } else {
                                throw new Error(await res.text());
                            }
                        } catch (e) {
                            alert("保存失败: " + e.message);
                            this.saveStatus = "保存失败";
                        }
                    },

                    // 从远程加载示例配置
                    async loadRemoteConfig() {
                        const url = prompt(
                            "请输入配置文件的 URL",
                            "https://raw.githubusercontent.com/joyanhui/ikuai-bypass/refs/heads/main/config_example.yml",
                        );
                        if (!url) return;
                        try {
                            const res = await fetch(url);
                            const txt = await res.text();
                            const doc = jsyaml.load(txt);
                            if (doc) {
                                // 简单覆盖几个关键字段演示
                                if (doc["ikuai-url"])
                                    this.config.ikuaiUrl = doc["ikuai-url"];
                                // 更多字段映射略... 实际逻辑同 loadBackendConfig
                                alert("已加载远程配置（部分字段覆盖）");
                            }
                        } catch (e) {
                            alert("加载失败: " + e.message);
                        }
                    },

                    // 辅助函数
                    addItem(key) {
                        const templates = {
                            customIsp: { name: "", url: "", tag: "" },
                            ipGroup: { name: "", url: "" },
                            ipv6Group: { name: "", url: "" },
                            streamDomain: {
                                interface: "wan1",
                                srcAddr: "",
                                url: "",
                                tag: "",
                            },
                            streamIpPort: {
                                type: "0",
                                interface: "wan1",
                                nexthop: "",
                                srcAddr: "",
                                ipGroup: "",
                                mode: "0",
                                ifaceband: "0",
                            },
                        };
                        this.config[key].push({ ...templates[key] });
                    },
                    removeItem(key, index) {
                        this.config[key].splice(index, 1);
                    },
                    async copyText(text) {
                        try {
                            await navigator.clipboard.writeText(text);
                            alert("已复制到剪贴板");
                        } catch (e) {
                            console.error(e);
                        }
                    },

                    // 计算属性：生成的命令
                    get generatedCmd() {
                        let cmd = `${this.cmd.exePath} -c ${this.cmd.configPath} -r ${this.cmd.runMode}`;
                        if (
                            this.cmd.runMode !== "clean" &&
                            this.cmd.runMode !== "web"
                        ) {
                            cmd += ` -m ${this.cmd.module}`;
                            if (this.cmd.delOldRule !== "after")
                                cmd += ` -delOldRule ${this.cmd.delOldRule}`;
                        }
                        return cmd;
                    },

                    // 计算属性：YAML 预览
                    get generatedYaml() {
                        // 简化版预览，仅供展示
                        const previewObj = {
                            "ikuai-url": this.config.ikuaiUrl,
                            username: this.config.username,
                            "...": "更多配置请点击保存查看服务器生成的文件",
                        };
                        return jsyaml.dump(previewObj);
                    },
                };
            }
        </script>
    </body>
</html>
